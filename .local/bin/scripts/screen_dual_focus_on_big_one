#!/bin/sh
# exec > /dev/null 2>&1
#
# HDMI="HDMI-A-0"
# LAPTOP="eDP"
#
# # Ce répertoire, prévu pour stocker les données éphémères de la session utilisateur, est nettoyé automatiquement à chaque déconnexion (ou reboot).
# # STATE_FILE="/run/user/$(id -u)/display_state"
# STATE_DIR="/run/user/$(id -u)/state_dualscreen_focus_on_big_one"
# STATE_FILE="$STATE_DIR/display_state"
#
# mkdir -p "$STATE_DIR"
#
#
# # Vérifie si HDMI est connecté
# is_hdmi_connected() {
#     xrandr | grep "^$HDMI connected" >/dev/null
# }
#
# # Etat à écrire: uniquement l'écran actif
# get_active_output() {
#     if is_hdmi_connected; then
#         echo "${HDMI}|"
#     else
#         echo "${LAPTOP}|"
#     fi
# }
#
# # Lit l'état précédent
# prev_state=""
# if [ -f "$STATE_FILE" ]; then
#     prev_state=$(cat "$STATE_FILE")
# fi
#
# # Récupère l'écran actif actuel
# current_state=$(get_active_output)
#
# # Agit seulement si l'état a changé
# if [ "$current_state" != "$prev_state" ]; then
#     echo "$current_state" > "$STATE_FILE"
#
#     if is_hdmi_connected; then
#         xrandr --output "$HDMI" --auto --primary --output "$LAPTOP" --off
#         feh --bg-fill "$WALLPAPER" > /dev/null 2>&1
#     else
#         xrandr --output "$LAPTOP" --auto --primary --output "$HDMI" --off
#         feh --bg-fill "$WALLPAPER" > /dev/null 2>&1
#     fi
#
#     # notify-send "Multiscreen" "Changement d'écran détecté, lancement de restart_xinitrc"
#     # restart_xinitrc
# fi
#
#



# ============================================================================
exec > /dev/null 2>&1

HDMI="HDMI-A-0"
LAPTOP="eDP"

STATE_DIR="/run/user/$(id -u)/state_dualscreen_focus_on_big_one"
STATE_FILE="$STATE_DIR/display_state"
LOCK_DIR="/run/user/$(id -u)/screen_mode_lock"
mkdir -p "$STATE_DIR" "$LOCK_DIR"

# Si un mode manuel est actif (duplicate ou multi_manual), ne rien faire
if [ -f "$LOCK_DIR/duplicate_manual" ] || [ -f "$LOCK_DIR/multi_manual" ]; then
    exit 0
fi

# Indique que focus est le mode actif
touch "$LOCK_DIR/focus_default"
rm -f "$LOCK_DIR/multi_default"

is_hdmi_connected() {
    xrandr | grep "^$HDMI connected" >/dev/null
}

get_active_output() {
    if is_hdmi_connected; then
        echo "HDMI"
    else
        echo "LAPTOP"
    fi
}

prev_state=""
if [ -f "$STATE_FILE" ]; then
    prev_state=$(cat "$STATE_FILE")
fi

current_state=$(get_active_output)

if [ "$current_state" != "$prev_state" ]; then
    echo "$current_state" > "$STATE_FILE"

    xrandr --output "$HDMI" --off --output "$LAPTOP" --off
    # sleep 0.5

    if [ "$current_state" = "HDMI" ]; then
        xrandr --output "$HDMI" --auto --primary
    else
        xrandr --output "$LAPTOP" --auto --primary
    fi

    if [ -n "$WALLPAPER" ] && command -v feh >/dev/null 2>&1; then
        # sleep 0.5
        feh --bg-fill "$WALLPAPER"
    fi
fi
