#!/bin/bash
exec > /dev/null 2>&1

STATE_DIR="/run/user/$(id -u)/state_multiscreen"
STATE_FILE="$STATE_DIR/display_state"

mkdir -p "$STATE_DIR"

PRIMARY="HDMI-A-0"  # écran externe principal

get_connected_outputs() {
    xrandr | awk '/ connected/{print $1}'
}

get_all_outputs() {
    xrandr | awk '/ connected|disconnected/{print $1}'
}

prev_state=""
if [ -f "$STATE_FILE" ]; then
    prev_state=$(cat "$STATE_FILE")
fi


# if [ -n "$prev_state" ]; then
#     # Enlever le dernier pipe si présent
#     prev_state="${prev_state%|}"
#
#     # Convertir la chaîne en lignes, trier, puis recombiner avec '|'
#     prev_state=$(echo "$prev_state" | tr '|' '\n' | sort | tr '\n' '|' )
# fi

mapfile -t outs < <(get_connected_outputs | sort)
current_state=$(printf "%s|" "${outs[@]}")
# echo $current_state

if [ "$current_state" != "$prev_state" ]; then
    if [ "$prev_state" == "" ]; then
        sleep 1
    fi
    echo "$current_state" > "$STATE_FILE"

    # Activation avec extension et positionnement
    for o in "${outs[@]}"; do
        if [ "$o" = "$PRIMARY" ]; then
            # écran principal activé en mode auto
            xrandr --output "$o" --auto --primary
        else
            # écrans secondaires positionnés à droite de l'écran principal, en mode auto
            xrandr --output "$o" --auto --right-of "$PRIMARY"
        fi
    done

    # Désactive les sorties déconnectées
    mapfile -t all_outs < <(get_all_outputs)
    for o in "${all_outs[@]}"; do
        if ! printf '%s\n' "${outs[@]}" | grep -qx "$o"; then
            xrandr --output "$o" --off
        fi
    done

    feh --bg-fill "$WALLPAPER"

    # notify-send "Multiscreen" "Changement d'écran détecté, lancement de restart_xinitrc"
    restart_xinitrc
fi

# echo $current_state
#
# for o in "${outs[@]}"; do
#     echo "$o"
# done
#
# mapfile -t all_outs < <(get_all_outputs)
# for o in "${all_outs[@]}"; do
#     if ! printf '%s\n' "${outs[@]}" | grep -qx "$o"; then
#         echo "$o"
#     fi
# done




