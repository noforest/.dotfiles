#!/bin/bash
# ============================================================================
# Force le passage en mode multi-écrans (version manuelle de screen_multi)
# ============================================================================

PRIMARY="HDMI-A-0"
LOCK_DIR="/run/user/$(id -u)/screen_mode_lock"
STATE_DIR="/run/user/$(id -u)/state_multiscreen"
STATE_FILE="$STATE_DIR/display_state"
mkdir -p "$STATE_DIR" "$LOCK_DIR"


rm -f "$LOCK_DIR/focus_manual"
rm -f "$LOCK_DIR/duplicate_manual"
# Active le mode manuel multi
touch "$LOCK_DIR/multi_manual"

get_connected_outputs() {
    xrandr | awk '/ connected/{print $1}'
}

get_all_outputs() {
    xrandr | awk '/ connected|disconnected/{print $1}'
}

mapfile -t outs < <(get_connected_outputs | sort)
current_state=$(printf "%s|" "${outs[@]}")
echo "$current_state" > "$STATE_FILE"

# Active l'écran principal
for o in "${outs[@]}"; do
    if [ "$o" = "$PRIMARY" ]; then
        xrandr --output "$o" --auto --primary
    else
        xrandr --output "$o" --auto --right-of "$PRIMARY"
    fi
done

# Désactive les sorties déconnectées
mapfile -t all_outs < <(get_all_outputs)
for o in "${all_outs[@]}"; do
    if ! printf '%s\n' "${outs[@]}" | grep -qx "$o"; then
        xrandr --output "$o" --off
    fi
done

if [ -n "$WALLPAPER" ] && command -v feh >/dev/null 2>&1; then
    feh --bg-fill "$WALLPAPER"
fi
